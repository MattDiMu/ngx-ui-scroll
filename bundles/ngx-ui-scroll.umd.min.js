!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?factory(exports,require("@angular/core"),require("@angular/common"),require("rxjs/Observable"),require("rxjs/BehaviorSubject")):"function"==typeof define&&define.amd?define(["exports","@angular/core","@angular/common","rxjs/Observable","rxjs/BehaviorSubject"],factory):factory((global.ng=global.ng||{},global.ng.ngxUiScroll={}),global.ng.core,global.ng.common,global.Rx,global.Rx)}(this,function(exports,core,common,Observable,BehaviorSubject){"use strict";
/**
 * @license ngx-ui-scroll
 * MIT license
 */var defaultSettings={startIndex:1,bufferSize:5,padding:.5,infinite:!1},Settings=function(){return function(settings){this.debug=!1,this.itemIdPrefix="ui-scroll-0-",this.clipAfterFetchOnly=!1,Object.assign(this,defaultSettings),settings&&"object"==typeof settings&&Object.assign(this,settings)}}(),Direction={forward:"forward",backward:"backward"},Routines=function(){function Routines(){}return Routines.getScrollPosition=function(element){return element.scrollTop},Routines.setScrollPosition=function(element,value){element.scrollTop=value},Routines.getParams=function(element){return element.getBoundingClientRect()},Routines.getSize=function(element){return Routines.getParams(element).height},Routines.getScrollableSize=function(element){return element.scrollHeight},Routines.getRectEdge=function(params,direction,opposite){return params[direction===(opposite?Direction.backward:Direction.forward)?"bottom":"top"]},Routines.getEdge=function(element,direction,opposite){var params=Routines.getParams(element);return Routines.getRectEdge(params,direction,opposite)},Routines.getEdge2=function(element,direction,relativeElement,opposite){return element.offsetTop-(relativeElement?relativeElement.scrollTop:0)+(direction===(opposite?Direction.backward:Direction.forward)?Routines.getSize(element):0)},Routines.hideElement=function(element){element.style.display="none"},Routines}(),Padding=function(){function Padding(element,direction){this.element=null,this.element=element.querySelector("[data-padding-"+direction+"]"),this.direction=direction}return Object.defineProperty(Padding.prototype,"size",{get:function(){return parseInt(this.element.style.height,10)||0},set:function(value){this.element.style.height=value+"px"},enumerable:!0,configurable:!0}),Padding.prototype.getEdge=function(){return Routines.getEdge(this.element,this.direction,!0)},Padding}(),ViewportPadding=function(){return function(element){this.forward=new Padding(element,Direction.forward),this.backward=new Padding(element,Direction.backward)}}(),Viewport=function(){function Viewport(elementRef,settings){this.settings=settings,this.host=elementRef.nativeElement,this.scrollable=elementRef.nativeElement.parentElement,this.padding=new ViewportPadding(this.host),this.syntheticScrollPosition=null}return Object.defineProperty(Viewport.prototype,"children",{get:function(){return this.host.children},enumerable:!0,configurable:!0}),Object.defineProperty(Viewport.prototype,"scrollPosition",{get:function(){return Routines.getScrollPosition(this.scrollable)},set:function(value){Routines.setScrollPosition(this.scrollable,value),this.syntheticScrollPosition=this.scrollPosition},enumerable:!0,configurable:!0}),Viewport.prototype.saveScrollPosition=function(){this.lastPosition=this.scrollPosition},Viewport.prototype.getLastPosition=function(){return this.lastPosition},Viewport.prototype.getSize=function(){return Routines.getSize(this.scrollable)},Viewport.prototype.getScrollableSize=function(){return Routines.getScrollableSize(this.scrollable)},Viewport.prototype.getBufferPadding=function(){return this.getSize()*this.settings.padding},Viewport.prototype.getEdge=function(direction,opposite){return Routines.getEdge(this.scrollable,direction,opposite)},Viewport.prototype.getLimit=function(direction,opposite){return this.getEdge(direction,opposite)+(direction===(opposite?Direction.backward:Direction.forward)?1:-1)*this.getBufferPadding()},Viewport}(),ItemCache=function(){function ItemCache(item){this.$index=item.$index,this.nodeId=item.nodeId,this.data=item.data,this.params=item.getParams()}return ItemCache.prototype.getEdge=function(direction,opposite){return Routines.getRectEdge(this.params,direction,opposite)},ItemCache}(),Cache=function(){function Cache(){this.items=[]}return Cache.prototype.add=function(item){var found=this.items.find(function(i){return i.$index===item.$index});found?(found.data=item.data,found.params=item.getParams()):this.items.push(new ItemCache(item))},Cache.prototype.get=function(index){return this.items.find(function(i){return i.$index===index})},Cache}(),Index=function(){return function(){this.forward=null,this.backward=null}}(),Buffer=function(){function Buffer(){this.$items=new BehaviorSubject.BehaviorSubject(null),this.items=[],this.bof=!1,this.eof=!1,this.lastIndex=new Index,this.cache=new Cache}return Object.defineProperty(Buffer.prototype,"items",{get:function(){return this._items},set:function(items){this._items=items,items.length&&this.setLastIndices(),this.$items.next(items)},enumerable:!0,configurable:!0}),Buffer.prototype.setLastIndices=function(){this.lastIndex[Direction.backward]=this.items[0].$index,this.lastIndex[Direction.forward]=this.items[this.items.length-1].$index},Buffer.prototype.getFirstVisibleItemIndex=function(){for(var length=this.items.length,i=0;i<length;i++)if(!this.items[i].invisible)return i;return-1},Buffer.prototype.getLastVisibleItemIndex=function(){for(var i=this.items.length-1;i>=0;i--)if(!this.items[i].invisible)return i;return-1},Buffer.prototype.getEdgeVisibleItemIndex=function(direction,opposite){return direction===(opposite?Direction.backward:Direction.forward)?this.getLastVisibleItemIndex():this.getFirstVisibleItemIndex()},Buffer.prototype.getFirstVisibleItem=function(){var index=this.getFirstVisibleItemIndex();if(index>=0)return this.items[index]},Buffer.prototype.getLastVisibleItem=function(){var index=this.getLastVisibleItemIndex();if(index>=0)return this.items[index]},Buffer.prototype.getEdgeVisibleItem=function(direction,opposite){return direction===(opposite?Direction.backward:Direction.forward)?this.getLastVisibleItem():this.getFirstVisibleItem()},Buffer}(),FetchByDirection=function(){function FetchByDirection(){this.count=0,this.reset()}return FetchByDirection.prototype.reset=function(){var count=this.count;this.shouldFetch=!1,this.startIndex=null,this._newItemsData=null,this.items=null,this.count=count},Object.defineProperty(FetchByDirection.prototype,"newItemsData",{get:function(){return this._newItemsData},set:function(items){this._newItemsData=items,this.count++},enumerable:!0,configurable:!0}),FetchByDirection}(),FetchModel=function(){function FetchModel(){this.forward=new FetchByDirection,this.backward=new FetchByDirection}return FetchModel.prototype.reset=function(){this[Direction.forward].reset(),this[Direction.backward].reset()},Object.defineProperty(FetchModel.prototype,"count",{get:function(){return this[Direction.backward].count+this[Direction.forward].count},enumerable:!0,configurable:!0}),Object.defineProperty(FetchModel.prototype,"items",{get:function(){return(this[Direction.backward].items?this[Direction.backward].items:[]).concat(this[Direction.forward].items?this[Direction.forward].items:[])},enumerable:!0,configurable:!0}),Object.defineProperty(FetchModel.prototype,"shouldFetch",{get:function(){return this[Direction.forward].shouldFetch||this[Direction.backward].shouldFetch},enumerable:!0,configurable:!0}),Object.defineProperty(FetchModel.prototype,"hasNewItems",{get:function(){return!(!this[Direction.forward].newItemsData&&!this[Direction.backward].newItemsData)},enumerable:!0,configurable:!0}),FetchModel}(),ClipByDirection=function(){return function(){this.shouldClip=!1,this.size=null}}(),ClipModel=function(){function ClipModel(){this.forward=new ClipByDirection,this.backward=new ClipByDirection}return Object.defineProperty(ClipModel.prototype,"shouldClip",{get:function(){return this[Direction.forward].shouldClip||this[Direction.backward].shouldClip},enumerable:!0,configurable:!0}),ClipModel}(),checkDatasource=function(datasource){if(!datasource)throw new Error("No datasource provided");if(!("get"in datasource))throw new Error("Datasource get method is not implemented");if("function"!=typeof datasource.get)throw new Error("Datasource get is not a function");if(datasource.get.length<2)throw new Error("Datasource get method invalid signature");return datasource},Workflow=function(){function Workflow(context){var _this=this;this.count=0,this.countDone=0,this.resolver=Observable.Observable.create(function(_observer){return _this.observer=_observer}),this.bindData=function(){_this.next=!0,context.changeDetector.markForCheck()},this.datasource=checkDatasource(context.datasource),this.settings=new Settings(context.datasource.settings),this.viewport=new Viewport(context.elementRef,this.settings),this.buffer=new Buffer,this.fetch=new FetchModel,this.clip=new ClipModel}return Workflow.prototype.reset=function(){this.pending=!1,this.direction=null,this.next=!1,this.fetch.reset(),this.clip=new ClipModel},Workflow.prototype.start=function(direction){return this.count++,this.log("---=== Workflow "+this.count+" run"),this.reset(),this.pending=!0,this.direction=direction||null,Promise.resolve(this)},Workflow.prototype.continue=function(){return Promise.resolve(this)},Workflow.prototype.finalize=function(){},Workflow.prototype.end=function(){this.pending=!1,this.countDone++,this.viewport.saveScrollPosition(),this.finalize()},Workflow.prototype.done=function(){this.log("---=== Workflow "+this.count+" done"),this.end(),this.observer.next(this.next)},Workflow.prototype.fail=function(error){this.log("---=== Workflow "+this.count+" fail"),this.end(),this.observer.error(error)},Workflow.prototype.dispose=function(){this.observer.complete()},Workflow.prototype.log=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];this.settings.debug&&console.log.apply(this,args)},Workflow}(),ShouldFetch=function(){function ShouldFetch(){}return ShouldFetch.run=function(workflow){return workflow.direction!==Direction.backward&&ShouldFetch.shouldFetchByDirection(Direction.forward,workflow),workflow.direction!==Direction.forward&&ShouldFetch.shouldFetchByDirection(Direction.backward,workflow),Promise.resolve(workflow)},ShouldFetch.shouldFetchByDirection=function(direction,workflow){var paddingEdge=workflow.viewport.padding[direction].getEdge(),limit=workflow.viewport.getLimit(direction);direction===Direction.forward&&workflow.buffer.eof||direction===Direction.backward&&workflow.buffer.bof?workflow.fetch[direction].shouldFetch=!1:workflow.fetch[direction].shouldFetch=direction===Direction.forward?paddingEdge<limit:paddingEdge>limit,workflow.fetch[direction].shouldFetch&&ShouldFetch.setStartIndex(direction,workflow)},ShouldFetch.setStartIndex=function(direction,workflow){var start,forward=direction===Direction.forward,back=-workflow.settings.bufferSize;start=null===workflow.buffer.lastIndex[direction]?workflow.settings.startIndex+(forward?0:back):workflow.buffer.lastIndex[direction]+(forward?1:back),workflow.fetch[direction].startIndex=start},ShouldFetch}(),Fetch=function(){function Fetch(){}return Fetch.run=function(workflow){var result=[];return workflow.fetch[Direction.backward].shouldFetch&&result.push(Fetch.fetchByDirection(Direction.backward,workflow)),workflow.fetch[Direction.forward].shouldFetch&&result.push(Fetch.fetchByDirection(Direction.forward,workflow)),Promise.all(result).then(function(){return workflow})},Fetch.success=function(data,direction,workflow){workflow.log("resolved "+data.length+" "+direction+" items (index = "+workflow.fetch[direction].startIndex+", count = "+workflow.settings.bufferSize+")"),workflow.fetch[direction].newItemsData=data},Fetch.fetchByDirection=function(direction,workflow){return new Promise(function(resolve,reject){var success=function(data){Fetch.success(data,direction,workflow),resolve(!0)},_getResult=(0,workflow.datasource.get)(workflow.fetch[direction].startIndex,workflow.settings.bufferSize,success,reject);_getResult&&"function"==typeof _getResult.then?_getResult.then(success,reject):_getResult&&"function"==typeof _getResult.subscribe&&_getResult.subscribe(success,reject)})},Fetch}(),Item=function(){function Item($index,data,nodeId){this.$index=$index,this.data=data,this.nodeId=nodeId,this.invisible=!0}return Item.prototype.getParams=function(){return Routines.getParams(this.element)},Item.prototype.getEdge=function(direction,opposite){return Routines.getEdge(this.element,direction,opposite)},Item.prototype.hide=function(){Routines.hideElement(this.element)},Item}(),ProcessFetch=function(){function ProcessFetch(){}return ProcessFetch.run=function(workflow){return ProcessFetch.runByDirection(workflow,Direction.backward),ProcessFetch.runByDirection(workflow,Direction.forward),workflow},ProcessFetch.runByDirection=function(workflow,direction){var fetch=workflow.fetch[direction];if(fetch.newItemsData){var eof=direction===Direction.forward?"eof":"bof";workflow.buffer[eof]=fetch.newItemsData.length!==workflow.settings.bufferSize,fetch.newItemsData.length&&(fetch.items=fetch.newItemsData.map(function(item,index){var $index=fetch.startIndex+index,nodeId=workflow.settings.itemIdPrefix+String($index);return new Item($index,item,nodeId)}),direction===Direction.forward?workflow.buffer.items=workflow.buffer.items.concat(fetch.items):workflow.buffer.items=fetch.items.concat(workflow.buffer.items))}},ProcessFetch}(),Render=function(){function Render(){}return Render.run=function(workflow){return workflow.fetch.hasNewItems?(workflow.bindData(),new Promise(function(resolve,reject){return setTimeout(function(){var error=Render.setElements(workflow);error?reject(error):resolve(workflow)})})):workflow},Render.setElements=function(workflow){for(var items=workflow.fetch.items,j=items.length-1;j>=0;j--){for(var nodes=workflow.viewport.children,i=nodes.length-1;i>=0;i--)nodes[i].id===items[j].nodeId&&(items[j].element=nodes[i]);if(!items[j].element)return new Error("Can not associate item with element")}},Render}(),AdjustFetch=function(){function AdjustFetch(){}return AdjustFetch.run=function(workflow){return AdjustFetch.runByDirection(Direction.forward,workflow),AdjustFetch.runByDirection(Direction.backward,workflow),workflow},AdjustFetch.runByDirection=function(direction,workflow){var items=workflow.fetch[direction].items;if(items){AdjustFetch.processFetchedItems(items);var height=Math.abs(items[0].element.getBoundingClientRect().top-items[items.length-1].element.getBoundingClientRect().bottom);return direction===Direction.forward?this.adjustForward(workflow,height):this.adjustBackward(workflow,height)}},AdjustFetch.processFetchedItems=function(items){for(var i=items.length-1;i>=0;i--){var element=items[i].element.children[0];element.style.left="",element.style.position="",items[i].invisible=!1}},AdjustFetch.adjustForward=function(workflow,size){var paddingForward=workflow.viewport.padding[Direction.forward],_paddingSize=paddingForward.size||0;paddingForward.size=Math.max(_paddingSize-size,0)},AdjustFetch.adjustBackward=function(workflow,size){var viewport=workflow.viewport,_scrollPosition=viewport.scrollPosition,paddingBackward=viewport.padding[Direction.backward],paddingForward=viewport.padding[Direction.forward],_paddingSize=paddingBackward.size||0,paddingSize=Math.max(_paddingSize-size,0);paddingBackward.size=paddingSize;var paddingDiff=size-(_paddingSize-paddingSize);if(paddingDiff>0){size=paddingDiff,viewport.scrollPosition+=size;var diff=size-viewport.scrollPosition-_scrollPosition;diff>0&&(paddingSize=paddingForward.size||0,paddingForward.size=paddingSize+diff,viewport.scrollPosition+=diff)}},AdjustFetch}(),ShouldClip=function(){function ShouldClip(){}return ShouldClip.run=function(workflow){return workflow.settings.clipAfterFetchOnly&&!workflow.fetch.shouldFetch?workflow:(ShouldClip.shouldClipByDirection(Direction.forward,workflow),ShouldClip.shouldClipByDirection(Direction.backward,workflow),workflow)},ShouldClip.shouldClipByDirection=function(direction,workflow){var items=workflow.buffer.items;if(!items.length)return!1;var i,itemEdge,index,forward=direction===Direction.forward,viewportLimit=workflow.viewport.getLimit(direction,!0),firstIndex=workflow.buffer.getFirstVisibleItemIndex(),lastIndex=workflow.buffer.getLastVisibleItemIndex(),firstItemEdge=items[firstIndex].getEdge(direction),lastItemEdge=items[lastIndex].getEdge(direction),start=-1,end=-1;if(forward&&lastItemEdge<=viewportLimit||!forward&&firstItemEdge>=viewportLimit)start=firstIndex,end=lastIndex;else for(forward?start=firstIndex:end=lastIndex,i=forward?0:lastIndex;forward?i<=lastIndex:i>=0;forward?i++:i--)if(itemEdge=(index=i)===firstIndex?firstItemEdge:index===lastIndex?lastItemEdge:items[index].getEdge(direction),forward&&itemEdge<=viewportLimit)end=i;else{if(forward||!(itemEdge>=viewportLimit))break;start=i}if(start>=0&&end>=0){for(i=start;i<=end;i++)items[i].toRemove=!0;workflow.clip[direction].shouldClip=!0,workflow.clip[direction].size=items[end].getEdge(Direction.forward)-items[start].getEdge(Direction.backward)}},ShouldClip}(),Clip=function(){function Clip(){}return Clip.run=function(workflow){return workflow.clip.shouldClip?(Clip.runByDirection(Direction.forward,workflow),Clip.runByDirection(Direction.backward,workflow),workflow.buffer.items=workflow.buffer.items.filter(function(item){return!item.toRemove||(workflow.buffer.cache.add(item),item.hide(),!1)}),workflow.bindData(),new Promise(function(resolve,reject){return setTimeout(function(){resolve(workflow)})})):workflow},Clip.runByDirection=function(direction,workflow){if(workflow.clip[direction].shouldClip){var opposite=direction===Direction.forward?Direction.backward:Direction.forward;workflow.viewport.padding[opposite].size+=workflow.clip[direction].size}},Clip}(),WorkflowRunner=function(){function WorkflowRunner(context){this.count=0,this.defaultDirection=Direction.forward,this.context=context,this.workflow=new Workflow(this.context),this.initialize()}return WorkflowRunner.prototype.initialize=function(){var _this=this,flow=this.workflow;this.onScrollListener=this.context.renderer.listen(flow.viewport.scrollable,"scroll",function($event){return _this.scroll($event)}),this.itemsSubscription=flow.buffer.$items.subscribe(function(items){return _this.context.items=items}),this.flowResolverSubscription=flow.resolver.subscribe(this.resolve.bind(this)),this.run()},WorkflowRunner.prototype.scroll=function($event){if(null!==this.workflow.viewport.syntheticScrollPosition){if(this.workflow.viewport.scrollPosition===this.workflow.viewport.syntheticScrollPosition)return void(this.workflow.viewport.syntheticScrollPosition=null);this.workflow.viewport.syntheticScrollPosition=null}this.run()},WorkflowRunner.prototype.resolve=function(next){this.newDirection?(this.run(this.newDirection),this.newDirection=null):next?this.run(this.workflow.direction):this.directionQueue?(this.run(this.directionQueue),this.directionQueue=null):(this.count++,this.finalize())},WorkflowRunner.prototype.run=function(direction){var _this=this;direction||(direction=this.defaultDirection,this.directionQueue=direction===Direction.forward?Direction.backward:Direction.forward),this.workflow.pending?this.newDirection=direction:this.workflow.start(direction).then(function(){return _this.fetch()}).then(function(){return _this.clip()}).then(function(){return _this.workflow.done()}).catch(function(error){return _this.workflow.fail(error)})},WorkflowRunner.prototype.fetch=function(){return this.workflow.continue().then(ShouldFetch.run).then(Fetch.run).then(ProcessFetch.run).then(Render.run).then(AdjustFetch.run)},WorkflowRunner.prototype.clip=function(){return this.workflow.settings.infinite?null:this.workflow.continue().then(ShouldClip.run).then(Clip.run)},WorkflowRunner.prototype.dispose=function(){this.onScrollListener(),this.itemsSubscription.unsubscribe(),this.flowResolverSubscription.unsubscribe(),this.workflow.dispose()},WorkflowRunner.prototype.finalize=function(){},WorkflowRunner}(),UiScrollComponent=function(){function UiScrollComponent(changeDetector,elementRef,renderer){this.changeDetector=changeDetector,this.elementRef=elementRef,this.renderer=renderer}return UiScrollComponent.prototype.ngOnInit=function(){this.workflowRunner=new WorkflowRunner(this)},UiScrollComponent.prototype.ngOnDestroy=function(){this.workflowRunner.dispose()},UiScrollComponent.decorators=[{type:core.Component,args:[{selector:"ui-scroll",changeDetection:core.ChangeDetectionStrategy.OnPush,template:'\n<div data-padding-backward></div>\n<div *ngFor="let item of items" id="{{item.nodeId}}">\n  <div [style.position]="item.invisible ? \'fixed\' : null" [style.left]="item.invisible ? \'-99999px\' : null" >\n    <ng-template\n      [ngTemplateOutlet]="template"\n      [ngTemplateOutletContext]="{\n        $implicit: item.data,\n        index: item.$index\n     }">\n    </ng-template>\n  </div>\n</div>\n<div data-padding-forward></div>\n'}]}],UiScrollComponent.ctorParameters=function(){return[{type:core.ChangeDetectorRef},{type:core.ElementRef},{type:core.Renderer2}]},UiScrollComponent}(),UiScrollDirective=function(){function UiScrollDirective(templateRef,viewContainer,resolver){this.templateRef=templateRef,this.viewContainer=viewContainer,this.resolver=resolver}return Object.defineProperty(UiScrollDirective.prototype,"uiScrollOf",{set:function(datasource){this.datasource=datasource},enumerable:!0,configurable:!0}),UiScrollDirective.prototype.ngOnInit=function(){var templateView=this.templateRef.createEmbeddedView({}),compFactory=this.resolver.resolveComponentFactory(UiScrollComponent),componentRef=this.viewContainer.createComponent(compFactory,null,this.viewContainer.injector,[templateView.rootNodes]);componentRef.instance.datasource=this.datasource,componentRef.instance.template=this.templateRef},UiScrollDirective.decorators=[{type:core.Directive,args:[{selector:"[uiScroll][uiScrollOf]"}]}],UiScrollDirective.ctorParameters=function(){return[{type:core.TemplateRef},{type:core.ViewContainerRef},{type:core.ComponentFactoryResolver}]},UiScrollDirective.propDecorators={uiScrollOf:[{type:core.Input}]},UiScrollDirective}(),UiScrollModule=function(){function UiScrollModule(){}return UiScrollModule.decorators=[{type:core.NgModule,args:[{declarations:[UiScrollComponent,UiScrollDirective],imports:[common.CommonModule],entryComponents:[UiScrollComponent],exports:[UiScrollDirective],providers:[]}]}],UiScrollModule.ctorParameters=function(){return[]},UiScrollModule}();exports.UiScrollModule=UiScrollModule,exports.ɵa=UiScrollComponent,exports.ɵb=UiScrollDirective,Object.defineProperty(exports,"__esModule",{value:!0})});